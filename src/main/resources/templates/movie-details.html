<!doctype html>
<html lang="ro" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: head(${movie.title} + ' • Cinema')}"></head>

<body>

<div th:replace="~{fragments/navbar :: navbar('movies')}"></div>

<main class="container py-4 py-md-5">

  <div class="d-flex align-items-end justify-content-between flex-wrap gap-2 mb-4">
    <div>
      <h1 class="text-light mb-1" th:text="${movie.title}">Movie title</h1>
      <div style="color: var(--muted);">
        <span th:text="${movie.genre}">Genre</span>
        • <span th:text="${movie.duration}">0</span> min
        • ⭐ <span th:text="${movie.rating}">0</span>
      </div>
    </div>
    <a class="btn btn-outline-light" th:href="@{/movies}">← Back to movies</a>
  </div>

  <div class="row g-4">

    <div class="col-12 col-lg-4">
      <div class="card p-3">
        <div class="ratio ratio-2x3 rounded overflow-hidden" style="background: rgba(255,255,255,0.06);">
          <img class="w-100 h-100" style="object-fit: cover;"
               th:if="${movie.imageUrl != null}"
               th:src="@{/img/movies/{file}(file=${movie.imageUrl})}"
               alt="Poster"
               onerror="this.style.display='none'">
        </div>

        <div class="mt-3 d-flex justify-content-between align-items-center gap-3">
          <div>
            <div class="fw-semibold">Preț de bază</div>
            <div style="color: var(--muted); font-size: .95rem;">(poate varia în funcție de tip)</div>
          </div>
          <div class="fw-semibold fs-5" th:text="${movie.basePrice} + ' lei'">0 lei</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-8">
      <div class="card p-3 p-md-4">
        <div class="d-flex gap-2 flex-wrap mb-3">
          <span class="badge badge-soft">Gen: <span th:text="${movie.genre}">Genre</span></span>
          <span class="badge badge-soft">Durată: <span th:text="${movie.duration}">0</span> min</span>
          <span class="badge badge-soft">Rating: ⭐ <span th:text="${movie.rating}">0</span></span>
          <span class="badge badge-soft" th:if="${movie.premiereDate != null}">
            Premieră: <span th:text="${#temporals.format(movie.premiereDate, 'dd MMM yyyy')}">—</span>
          </span>
        </div>

        <h2 class="h5 mb-2">Descriere</h2>
        <p class="mb-0" style="color: var(--muted);" th:text="${movie.description}">
          Description...
        </p>
      </div>

      <div class="card p-3 p-md-4 mt-3">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <div class="fw-semibold">Rezervare locuri</div>
            <div style="color: var(--muted); font-size: .95rem;">
              În versiunea curentă, rezervarea se face din pagina de show-uri.
            </div>
          </div>
          <a class="btn btn-primary" th:href="@{/movies}">Vezi alte filme</a>
        </div>
      </div>
    </div>

    <!-- Showtimes + booking -->
    <div class="card p-3 p-md-4 mt-3">
      <div class="d-flex justify-content-between align-items-end flex-wrap gap-2 mb-2">
        <div>
          <div class="fw-semibold">Alege o oră</div>
          <div style="color: var(--muted); font-size: .95rem;">Apasă pe o oră ca să alegi locurile.</div>
        </div>
        <a class="btn btn-sm btn-outline-light" th:href="@{/movies}">Înapoi la lista de filme</a>
      </div>

      <div th:if="${#maps.isEmpty(showsByDate)}" style="color: var(--muted);">
        Nu există show-uri pentru acest film încă.
      </div>

      <div class="d-flex flex-column gap-3" th:if="${!#maps.isEmpty(showsByDate)}">
        <div th:each="entry : ${showsByDate}">
          <div class="fw-semibold mb-2"
               th:text="${#temporals.format(entry.key, 'EEEE, dd MMM yyyy')}">Date</div>

          <div class="d-flex gap-2 flex-wrap">
            <a class="btn btn-outline-light"
               th:each="s : ${entry.value}"
               th:href="@{/booking(showId=${s.idShow})}">
              <span th:text="${#temporals.format(s.time, 'HH:mm')}">18:10</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- REVIEWS -->
    <div class="mt-4">
      <h4 class="text-light">Review-uri</h4>

      <div class="mb-2" style="color: var(--muted);" th:if="${avgRating != null}">
        Rating mediu: <span th:text="${#numbers.formatDecimal(avgRating, 1, 1)}">4.5</span>/5
      </div>

      <!-- FORM doar logat -->
      <div th:if="${canReview}" class="card p-3 mb-3">
        <form th:action="@{/reviews}" method="post">
          <input type="hidden" name="idFilm" th:value="${movie.idMovie}">

          <label class="text-light">Rating</label>
          <select name="rating" class="form-select" required>
            <option value="5">5</option>
            <option value="4">4</option>
            <option value="3">3</option>
            <option value="2">2</option>
            <option value="1">1</option>
          </select>

          <label class="text-light mt-2">Review</label>
          <textarea name="textReview" class="form-control" rows="3" maxlength="1000" required></textarea>

          <button class="btn btn-outline-light mt-3">Trimite</button>
        </form>
      </div>

      <div th:unless="${canReview}" style="color: var(--muted);" class="mb-3">
        Trebuie să fii logat ca să lași un review.
      </div>

      <!-- LISTA -->
      <div th:if="${#lists.isEmpty(reviews)}" style="color: var(--muted);">
        Niciun review încă.
      </div>

      <div th:if="${!#lists.isEmpty(reviews)}" class="d-flex flex-column gap-2">

        <div th:each="r : ${reviews}" th:if="${r != null}" class="card p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <span class="review-username"
                    th:text="${r.username != null ? r.username : 'user'}">user</span>
              <span style="color: rgba(255,255,255,0.4)">•</span>
              <strong th:text="${r.rating}">5</strong>/5
            </div>

            <div class="review-date"
                 th:text="${r.date != null ? #temporals.format(r.date, 'dd MMM yyyy HH:mm') : ''}">
              2026-01-11
            </div>
          </div>

          <div class="mt-2" th:text="${r.textReview}">Text review</div>
        </div>

      </div>
    </div>

  </div>

</main>

<style>
  .review-username {
    color: rgba(255, 255, 255, 0.75);
    font-weight: 600;
  }
  .review-date {
    color: rgba(255, 255, 255, 0.55);
    font-size: 0.85rem;
  }
</style>

<div th:replace="~{fragments/footer :: footer}"></div>
<div th:replace="~{fragments/scripts :: scripts}"></div>

</body>
</html>
